# Rust + Tauri如何实现管理员权限运行程序？

咱们要想把3Dmigoto Loader.exe去掉，然后换成直接调用那几个Windows API来实现同样的效果的话，就必须让SSMT4能够以管理员权限运行，但是我问了AI很久都没解决。


参考Issue：
https://github.com/tauri-apps/tauri/issues/7173

## 解决方案 (Tauri v2)

在 Tauri v2 中，直接使用 `winres` 库手动嵌入 Manifest 会导致与 Tauri 内置的资源（如版本信息、图标）发生冲突，产生 `LNK1123: duplicate resource` 错误。

正确的做法是通过 `tauri-build` 提供的 API 来注入 Manifest。

### 1. 创建 Manifest 文件

在 `src-tauri` 目录下创建 `windows-manifest.xml`：

```xml
<?xml version="1.0" encoding="utf-8"?>
<assembly xmlns="urn:schemas-microsoft-com:asm.v1" manifestVersion="1.0">
  <dependency>
    <dependentAssembly>
      <assemblyIdentity
        type="win32"
        name="Microsoft.Windows.Common-Controls"
        version="6.0.0.0"
        processorArchitecture="*"
        publicKeyToken="6595b64144ccf1df"
        language="*"
      />
    </dependentAssembly>
  </dependency>
  <trustInfo xmlns="urn:schemas-microsoft-com:asm.v3">
    <security>
      <requestedPrivileges>
        <!-- requireAdministrator 强制 Windows 在启动时弹出 UAC 提示 -->
        <requestedExecutionLevel level="requireAdministrator" uiAccess="false"/>
      </requestedPrivileges>
    </security>
  </trustInfo>
</assembly>
```

### 2. 修改构建脚本 (`build.rs`)

修改 `src-tauri/build.rs`，使用 `tauri_build` 的 `windows_attributes` 来加载 Manifest。这样 Tauri 会自动处理资源合并，避免冲突。

```rust
fn main() {
    let mut windows = tauri_build::WindowsAttributes::new();
    // 读取并注入 manifest 文件
    windows = windows.app_manifest(include_str!("windows-manifest.xml"));

    tauri_build::try_build(
        tauri_build::Attributes::new().windows_attributes(windows)
    ).expect("failed to run build script");
}
```

### 3. 清理依赖 (`Cargo.toml`)

确保 `src-tauri/Cargo.toml` 中**没有** `winres` 依赖，只需要 `tauri-build`。

```toml
[build-dependencies]
tauri-build = { version = "2", features = [] }
# winres = "0.1"  <-- 删除这个，不需要了
```

### 4. 开发注意事项

配置生效后，程序启动时会强制要求管理员权限。

如果在 VS Code 终端中运行 `bun run tauri dev` 遇到以下错误：
```
error: could not execute process `target\debug\ssmt4.exe` (never executed)
Caused by:
  请求的操作需要提升。 (os error 740)
```
这是因为 VS Code 默认是以普通用户权限运行的，无法启动一个要求管理员权限的子进程。

**解决方法：**
*   **以管理员身份运行 VS Code**，然后再运行开发命令。
*   或者直接在资源管理器中双击运行构建好的 `.exe` 文件。

Nico: 所以你得通过任务管理器查看一下VSCode的文件，然后创建一个快捷方式到桌面，然后设为管理员权限运行那个快捷方式

以后开发SSMT4都得通过管理员方式运行，否则bun run tauri dev无法通过。

但是如果通过管理员权限启动VSCode的话，就会导致不能打开其它的VSCode窗口，他奶奶滴！

最终决定，还是不使用Rust + Tauri了。

或者跟WinUI3一样，我们直接调用外部的exe来实现这些功能。
