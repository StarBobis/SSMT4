# 实现文件夹选择功能（Tauri + Vue）

本文档记录在 Tauri + Vue 项目中实现“前端点击按钮弹出文件/文件夹选择对话框并把选中的路径填回输入框”的完整流程、注意事项及排查方法，方便日后复用和排查问题。

---

## 高层概览

- 前端：使用 `@tauri-apps/plugin-dialog` 的 `open()` API 打开系统对话框，并把结果赋值到 `v-model` 绑定的变量。
- 后端（Rust）：在 `src-tauri` 中注册 `tauri-plugin-dialog` 插件，并为窗口分配允许调用 dialog 的 capability/permission。
- 编辑器/TS：确保 TypeScript 能解析 `@tauri-apps/*`，并包含 Tauri 生成的类型声明以消除 IDE 报红。
- 运行：必须用 `bun run tauri dev`（或等价命令）运行整个应用以使插件生效；仅运行前端 dev server 无法弹出原生对话框。

---

## 详细步骤（必做）

1. 安装前端包

```powershell
bun add @tauri-apps/plugin-dialog
```

2. 在 Rust 端添加依赖并注册插件

- 在 `src-tauri/Cargo.toml` 添加：

```toml
[dependencies]
tauri-plugin-dialog = "2"
```

- 在 `src-tauri/src/lib.rs`（或 `main.rs` 的 builder）注册插件：

```rust
tauri::Builder::default()
	.plugin(tauri_plugin_dialog::init())
	// ...
```

3. 在 capability 中允许 dialog 权限（非常关键）

- 在 `src-tauri/capabilities/default.json`（或项目使用的 capability 文件）中加入：

```json
"permissions": [
	"core:default",
	"opener:default",
	"dialog:default",
	"dialog:allow-open"
]
```

注：`dialog:allow-open` 对应 `open()`，如果需要保存对话框或其他 dialog 权限，添加相应 `dialog:allow-save` 等。

4. 前端代码：从正确的模块导入并使用 `open`

- 正确导入（注意：使用 `@tauri-apps/plugin-dialog`）：

```ts
import { open } from '@tauri-apps/plugin-dialog'
```

- 简单示例（Vue 3 + script setup）：

```ts
import { ref } from 'vue'
import { open } from '@tauri-apps/plugin-dialog'

const path = ref('')

const selectPath = async () => {
	try {
		const selected = await open({ directory: true })
		if (selected) {
			path.value = Array.isArray(selected) ? selected[0] : selected
		}
	} catch (error) {
		console.error('选择路径失败:', error)
	}
}
```

5. TypeScript / 编辑器配置（防止 “报红”）

- 在 `tsconfig.json` 添加 `baseUrl`/`paths` 帮助解析，并在 `include` 中加入 Tauri 生成的 types：

```json
{
	"compilerOptions": {
		"baseUrl": ".",
		"paths": { "@tauri-apps/*": ["node_modules/@tauri-apps/*"] }
	},
	"include": ["src/**/*.ts","src/**/*.vue","src-tauri/gen/**/*.d.ts"]
}
```

- 如果编辑器仍然报红，重启 TS server（VS Code：Ctrl+Shift+P → "TypeScript: Restart TS server"）或重启 VS Code。推荐使用 Volar。

6. 运行（必须加载 Rust 主进程插件）

```powershell
bun run tauri dev
```

仅运行 `bun run dev`（前端）**无法**弹出系统对话框。

---

## 常见问题与排查建议

- 报错：`dialog.open not allowed. Permissions associated with this command: dialog:allow-open, dialog:default`
	- 原因：capability/permission 未授予。
	- 解决：在 `src-tauri/capabilities/<...>.json` 中加入 `dialog:default` 与 `dialog:allow-open`，并确保 capability 的 `windows` 包含目标窗口 label（例如 `main`）。

- 报错：VS Code 报红 “Cannot find module '@tauri-apps/...'”
	- 原因：TS 无法解析模块或 types。
	- 解决：确认 `node_modules/@tauri-apps/plugin-dialog` 已安装；更新 `tsconfig.json` 的 `paths` 与 `include`；重启 TS server。

- 问题：只启动前端服务器无法弹框
	- 说明：必须跑 `tauri dev`（或打包运行的可执行文件），因为对话框 API 需要 Rust 插件运行环境。

- 平台：Linux 上若对话框异常，可考虑启用 XDG portal 支持或使用 `xdg-portal` 特性（需要额外依赖）。

---

## 可选改进 / 额外建议

- 若 editor 类型仍不完善，可临时添加声明文件 `src/types/tauri-dialog.d.ts`，声明 `open()` 的基本签名（仅作为临时补救）。长期建议依赖官方包自带的类型声明与正确的 `tsconfig`。
- 若项目中使用了错误的导入（例如 `@tauri-apps/api/dialog`），建议在仓库中统一替换为 `@tauri-apps/plugin-dialog`（我已帮忙在本仓库替换过相关导入）。
- 权限最小化：仅开放需要的 capability，避免把过多权限暴露给前端窗口。

---

## 测试清单（按序执行）

1. 安装前端包：`bun add @tauri-apps/plugin-dialog`
2. 在 `Cargo.toml` 添加 `tauri-plugin-dialog`，并在 `lib.rs` 注册 `.plugin(tauri_plugin_dialog::init())`
3. 在 capability 文件中加入 `dialog:default` 与 `dialog:allow-open`（并确认 `windows` 包含 `main`）
4. 前端导入 `open` 并实现 `selectPath` 绑定到按钮
5. 重启 TS server（如有类型错误）
6. 运行：`bun run tauri dev`，测试选择路径是否能弹出与回填


